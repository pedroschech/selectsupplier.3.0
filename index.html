<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SelectSupplier — Sistema de Apoio à Seleção de Fornecedores</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- html2pdf (para exportar PDF do DOM) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root{
  --navy:#001a4d;--blue:#003f91;--bg:#0b1424;--card:#0f2340;--card2:#122a4d;
  --border:#1e3a5f;--text:#eaf0ff;--muted:#c5cee0;--accent:#ff6a00;
  --green:#16a34a;--yellow:#facc15;--red:#dc2626;--radius:16px;
  --swot-f:"#fff8d6"; --swot-o:"#ffe6e6"; --swot-r:"#e6fff0"; --swot-a:"#e6f0ff";
}
*{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,sans-serif}
html,body{height:100%;margin:0;background:radial-gradient(1000px 600px at -10% -10%,#0d1f3a 0%,#0b1424 60%);color:var(--text)}
header{background:linear-gradient(135deg,var(--navy),var(--blue));color:#fff;display:flex;gap:12px;align-items:center;padding:18px 20px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
header img{height:44px}
header h1{margin:0;font-size:1.45rem}
header p{margin:0;color:#e9efff;font-size:.9rem}
main{max-width:1280px;margin:18px auto;padding:0 18px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;box-shadow:0 8px 24px rgba(0,0,0,.28);margin-bottom:16px}
.btn{background:var(--accent);border:none;border-radius:999px;color:#fff;padding:8px 14px;font-weight:700;cursor:pointer}
.btn.secondary{background:#2a4a78}
.btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn.danger{background:var(--red)}
input,select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0e223d;color:var(--text)}
input[type="number"]{max-width:120px}
table{width:100%;border-collapse:collapse;margin-top:8px;font-size:.92rem}
th,td{border:1px solid var(--border);padding:6px 8px;vertical-align:top;color:var(--text)}
th{background:#16395e;text-align:left}
.tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.tab-btn{background:#0e223d;border:1px solid var(--border);color:var(--text);padding:7px 14px;border-radius:999px;cursor:pointer}
.tab-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
.section{display:none}
.section.active{display:block}
.legend{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0;color:var(--text)}
.box{width:14px;height:14px;border-radius:3px;display:inline-block}
.pill{display:inline-flex;gap:6px;align-items:center;background:#0e223d;border:1px solid var(--border);padding:2px 8px;border-radius:999px}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
@media (max-width:980px){.col-6,.col-4,.col-3{grid-column:span 12}}
footer{text-align:center;color:var(--muted);font-size:.85rem;margin:20px 0}

/* LOGIN overlay */
#loginOverlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:50}
#loginCard{background:var(--card2);color:var(--text);border-radius:14px;max-width:420px;width:100%;padding:18px 20px;border:1px solid var(--border)}
#loginCard h2{margin:4px 0 6px}
#loginCard input{background:#0e223d;color:var(--text);border:1px solid var(--border)}
#loginCard .btn{width:100%}
.small{font-size:.86rem}
.muted{color:var(--muted)}
.divider{height:1px;background:var(--border);margin:10px 0}
.badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--border);background:var(--card2);border-radius:999px}
.card-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:980px){.card-grid{grid-template-columns:repeat(1,1fr)}}

/* SWOT */
.swot-wrap{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.swot-card{padding:10px;border-radius:8px;min-height:90px;font-weight:700;color:#000}
.swot-F{background:#fff8d6}
.swot-O{background:#ffe6e6}
.swot-R{background:#e6fff0}
.swot-A{background:#e6f0ff}

.notice{background:#10253a;padding:10px;border-radius:8px;border:1px solid var(--border);color:var(--muted)}
</style>
</head>

<body>
<header>
  <img alt="logo" src="data:image/svg+xml;utf8,
    <svg xmlns='http://www.w3.org/2000/svg' width='44' height='44'>
      <rect width='44' height='44' rx='9' fill='%23003f91'/>
      <path d='M10 30 L22 10 L34 30 Z' fill='%23ff6a00'/>
    </svg>">
  <div>
    <h1>SelectSupplier</h1>
    <p>Sistema de Apoio à Seleção de Fornecedores · AGEPE II — Escola Politécnica da PUCRS</p>
  </div>
</header>

<!-- LOGIN -->
<div id="loginOverlay">
  <div id="loginCard">
    <h2>Entre para acessar</h2>
    <p class="small muted">Insira usuário e senha.</p>
    <label>Usuário</label><input id="loginUser">
    <label>Senha</label><input id="loginPass" type="password">
    <button class="btn" style="margin-top:10px" onclick="doLogin()">Entrar</button>
    <div id="loginErr" style="display:none;color:#ffd0d0;font-weight:600;margin-top:8px">Credenciais incorretas.</div>
  </div>
</div>

<main id="app" style="display:none">
  <div class="card">
    <div class="tabs">
      <button class="tab-btn active" data-tab="dashboard" onclick="switchTab(event,'dashboard')">Dashboard</button>
      <button class="tab-btn" data-tab="projeto" onclick="switchTab(event,'projeto')">Projeto</button>
      <button class="tab-btn" data-tab="fornecedores" onclick="switchTab(event,'fornecedores')">Fornecedores</button>
      <button class="tab-btn" data-tab="orçamentistas" onclick="switchTab(event,'orçamentistas')">Orçamentistas</button>
      <button class="tab-btn" data-tab="clientes" onclick="switchTab(event,'clientes')">Clientes</button>
      <button class="tab-btn" data-tab="indices" onclick="switchTab(event,'indices')">Índices</button>
      <button class="tab-btn" data-tab="cadastro" onclick="switchTab(event,'cadastro')">Manutenção/Cadastro</button>
      <button class="tab-btn" data-tab="projetos" onclick="switchTab(event,'projetos')">Projetos</button>
      <button class="tab-btn" data-tab="sobre" onclick="switchTab(event,'sobre')">Sobre</button>
    </div>
<body class="bg-gray-100">

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="h-screen flex items-center justify-center bg-gray-200">
        <div class="bg-white p-8 shadow-lg rounded-lg w-96">
            <h2 class="text-2xl font-bold text-center mb-6 text-blue-900">SelectSupplier</h2>

            <label class="block text-sm font-bold mb-1 text-blue-900">Usuário</label>
            <input id="loginUser" type="text" class="w-full p-2 border rounded mb-4">

            <label class="block text-sm font-bold mb-1 text-blue-900">Senha</label>
            <input id="loginPass" type="password" class="w-full p-2 border rounded mb-6">

            <button onclick="doLogin()" class="w-full bg-blue-900 text-white p-2 rounded hover:bg-blue-800">
                Entrar
            </button>

            <p id="loginError" class="text-red-600 text-center mt-3 hidden">Usuário ou senha incorretos</p>
        </div>
    </div>

    <!-- APP CONTENT -->
    <div id="appContent" class="hidden">

        <!-- NAVBAR -->
        <nav class="bg-blue-900 text-white p-4 flex justify-between">
            <span class="font-bold text-lg">SelectSupplier</span>

            <div class="space-x-4">
                <button onclick="showTab('projetoTab')" class="hover:underline">Projeto</button>
                <button onclick="showTab('fornecedoresTab')" class="hover:underline">Fornecedores</button>
                <button onclick="showTab('orcamentistasTab')" class="hover:underline">Orçamentistas</button>
                <button onclick="showTab('clientesTab')" class="hover:underline">Clientes</button>
                <button onclick="showTab('indicesTab')" class="hover:underline">Índices</button>
                <button onclick="showTab('projetosHistoricoTab')" class="hover:underline">Projetos</button>
                <button onclick="showTab('sobreTab')" class="hover:underline">Sobre</button>
                <button onclick="logout()" class="hover:underline ml-6 text-red-300">Sair</button>
            </div>
        </nav>

        <!-- ALL TABS WRAPPER -->
        <div class="p-6">

            <!-- ========== TAB: PROJETO (CRIAR / EDITAR) ========== -->
            <div id="projetoTab" class="tabSection hidden">

                <h2 class="text-2xl font-bold mb-4 text-blue-900">Novo Projeto</h2>

                <div class="grid grid-cols-2 gap-4">

                    <div>
                        <label class="font-bold text-blue-900">Nome do Projeto</label>
                        <input id="projNome" class="w-full p-2 border rounded">
                    </div>

                    <div>
                        <label class="font-bold text-blue-900">Orçamentista</label>
                        <select id="projOrcamentista" class="w-full p-2 border rounded"></select>
                    </div>

                    <div>
                        <label class="font-bold text-blue-900">Cliente</label>
                        <select id="projCliente" class="w-full p-2 border rounded"></select>
                    </div>

                    <div>
                        <label class="font-bold text-blue-900">Descrição</label>
                        <textarea id="projDescricao" class="w-full p-2 border rounded"></textarea>
                    </div>

                </div>

                <hr class="my-6">

                <!-- ÁREAS DO PROJETO -->
                <h3 class="text-xl font-bold text-blue-900 mb-4">Áreas do Projeto</h3>

                <div id="areasContainer"></div>

                <button onclick="addArea()" class="mt-3 bg-blue-900 text-white px-4 py-2 rounded">
                    + Adicionar Área
                </button>

                <hr class="my-6">

                <!-- ÍNDICES E PESOS -->
                <h3 class="text-xl font-bold text-blue-900 mb-4">Pesos dos Índices (Total ≤ 100%)</h3>

                <div id="pesosContainer"></div>

                <p id="pesoErro" class="text-red-600 font-bold hidden">Soma dos pesos excede 100%</p>

                <hr class="my-6">

                <!-- SWOT OPTIONAL -->
                <h3 class="text-xl font-bold text-blue-900 mb-3">Adicionar SWOT? (Opcional)</h3>
                <label class="flex items-center">
                    <input id="usarSwot" type="checkbox" class="mr-2">
                    <span class="font-bold text-blue-900">Incluir análise SWOT/FOFA</span>
                </label>

                <div id="swotContainer" class="grid grid-cols-2 gap-4 mt-4 hidden">
                    <div class="bg-yellow-200 p-4 rounded">
                        <h4 class="font-bold mb-2">Forças</h4>
                        <textarea id="swotForcas" class="w-full p-2 border rounded"></textarea>
                    </div>

                    <div class="bg-red-200 p-4 rounded">
                        <h4 class="font-bold mb-2">Fraquezas</h4>
                        <textarea id="swotFraquezas" class="w-full p-2 border rounded"></textarea>
                    </div>

                    <div class="bg-green-200 p-4 rounded">
                        <h4 class="font-bold mb-2">Oportunidades</h4>
                        <textarea id="swotOportunidades" class="w-full p-2 border rounded"></textarea>
                    </div>

                    <div class="bg-blue-200 p-4 rounded">
                        <h4 class="font-bold mb-2">Ameaças</h4>
                        <textarea id="swotAmeacas" class="w-full p-2 border rounded"></textarea>
                    </div>
                </div>

                <hr class="my-6">

                <button onclick="calcularProjeto()" class="bg-green-700 text-white px-6 py-2 rounded">
                    Calcular Projeto
                </button>

                <div id="resultadoProjeto" class="mt-6"></div>
            </div>
        </div>
    </div>

    <!-- ========================= ABA ORÇAMENTISTAS ========================= -->
    <div id="abaOrcamentistas" class="hidden">
        <h2 class="text-xl font-bold mb-4">Orçamentistas</h2>

        <div class="flex gap-2 mb-4">
            <input id="novoOrcamentista" type="text" placeholder="Nome do orçamentista"
                   class="border p-2 rounded w-full">
            <button onclick="adicionarOrcamentista()" class="bg-blue-700 text-white px-4 py-2 rounded">
                Adicionar
            </button>
        </div>

        <div id="listaOrcamentistas" class="space-y-2"></div>
    </div>

    <!-- ========================= ABA CLIENTES ========================= -->
    <div id="abaClientes" class="hidden">
        <h2 class="text-xl font-bold mb-4">Clientes</h2>

        <div class="flex gap-2 mb-4">
            <input id="novoCliente" type="text" placeholder="Nome do cliente"
                   class="border p-2 rounded w-full">
            <button onclick="adicionarCliente()" class="bg-blue-700 text-white px-4 py-2 rounded">
                Adicionar
            </button>
        </div>

        <div id="listaClientes" class="space-y-2"></div>
    </div>

    <!-- ========================= ABA ÍNDICES ========================= -->
    <div id="abaIndices" class="hidden">
        <h2 class="text-xl font-bold mb-4">Índices</h2>

        <div class="grid grid-cols-5 gap-2 mb-4">
            <input id="novoIndiceId" type="text" placeholder="ID"
                   class="border p-2 rounded">
            <input id="novoIndiceNome" type="text" placeholder="Nome"
                   class="border p-2 rounded">
            <select id="novoIndiceEscopo" class="border p-2 rounded">
                <option value="global">Global</option>
                <option value="area">Área</option>
            </select>
            <input id="novoIndiceDesc" type="text" placeholder="Descrição"
                   class="border p-2 rounded">
            <button onclick="adicionarIndice()" class="bg-blue-700 text-white px-4 py-2 rounded">
                Adicionar
            </button>
        </div>

        <div id="listaIndices" class="space-y-2"></div>
    </div>

    <!-- ========================= ABA PROJETOS ========================= -->
    <div id="abaProjetos" class="hidden">
        <h2 class="text-xl font-bold mb-4">Projetos</h2>

        <div class="flex gap-4 mb-4">
            <select id="filtroStatus" class="border p-2 rounded">
                <option value="">Todos os status</option>
                <option value="A iniciar">A iniciar</option>
                <option value="Em andamento">Em andamento</option>
                <option value="Concluído">Concluído</option>
            </select>

            <select id="filtroOrc" class="border p-2 rounded"></select>
            <select id="filtroCliente" class="border p-2 rounded"></select>

            <button onclick="listarProjetos()" class="bg-blue-700 text-white px-4 py-2 rounded">
                Filtrar
            </button>
        </div>

        <div id="listaProjetos" class="space-y-3"></div>

        <div id="detalheProjeto" class="mt-6 hidden"></div>
    </div>

    <!-- ========================= ABA SOBRE ========================= -->
    <div id="abaSobre" class="hidden">
        <h2 class="text-xl font-bold">Sobre</h2>

        <p class="mt-4 text-gray-300">
            Sistema de Apoio à Seleção de Fornecedores — protótipo acadêmico para AGEPE II · PUCRS.
        </p>

        <p class="mt-2 text-gray-400">
            Inclui: múltiplas áreas, notas por processo, matriz SWOT opcional, ranking completo,
            dashboards, CRUD de clientes, orçamentistas e índices, e exportação em PDF.
        </p>
    </div>

</div>

<!-- ========================= SCRIPTS PRINCIPAIS ========================= -->
<script>
let fornecedores = JSON.parse(localStorage.getItem("fornecedores")) || [];
let orcamentistas = JSON.parse(localStorage.getItem("orcamentistas")) || [
    "Bruno Ullmann", "Lucas Sitieni", "Pedro Schech", "Rafael Hirt"
];
let clientes = JSON.parse(localStorage.getItem("clientes")) || [
    "Alpha Solutions", "MegaTech", "Construmax", "LogiService", "Nordic Steel",
    "Plasma Prime", "TecnoPark", "MetalSul", "Arion Group", "NewBridge",
    "SinergyCorp", "Orion Dynamics", "SilverFox", "TerraPrime", "HydraWorks",
    "TotalForce", "Lumen Industrial", "BlueSquare", "Axis Comércio", "PrimeWave"
];
let indices = JSON.parse(localStorage.getItem("indices")) || [
    {id:"I1", nome:"Preço", escopo:"global", desc:"Preço ofertado"},
    {id:"I2", nome:"Qualidade", escopo:"global", desc:"Avaliação de qualidade"},
    {id:"I3", nome:"Lead time", escopo:"global", desc:"Prazo de entrega"}
];
let projetos = JSON.parse(localStorage.getItem("projetos")) || [];

function salvar() {
    localStorage.setItem("fornecedores", JSON.stringify(fornecedores));
    localStorage.setItem("orcamentistas", JSON.stringify(orcamentistas));
    localStorage.setItem("clientes", JSON.stringify(clientes));
    localStorage.setItem("indices", JSON.stringify(indices));
    localStorage.setItem("projetos", JSON.stringify(projetos));
}

function abrirAba(aba) {
    document.querySelectorAll("#menu button").forEach(b => b.classList.remove("bg-blue-800"));
    event.target.classList.add("bg-blue-800");

    document.querySelectorAll("main > div").forEach(sec => sec.classList.add("hidden"));
    document.getElementById(aba).classList.remove("hidden");

    if (aba === "abaOrcamentistas") renderOrcamentistas();
    if (aba === "abaClientes") renderClientes();
    if (aba === "abaIndices") renderIndices();
    if (aba === "abaProjetos") listarProjetos();
    if (aba === "abaFornecedores") renderFornecedores();
    if (aba === "abaNovoProjeto") preencherCombosProjeto();
    if (aba === "abaDashboard") atualizarDashboard();
}

function preencherCombosProjeto() {
    let orc = document.getElementById("selecionarOrc");
    let cli = document.getElementById("selecionarCliente");

    orc.innerHTML = "";
    cli.innerHTML = "";

    orcamentistas.forEach(o => {
        let op = document.createElement("option");
        op.textContent = o;
        orc.appendChild(op);
    });

    clientes.forEach(c => {
        let op = document.createElement("option");
        op.textContent = c;
        cli.appendChild(op);
    });
}

function toggleSWOT() {
    document.getElementById("swotContainer").classList.toggle("hidden");
}
/* ========================= CRUD ORÇAMENTISTAS ========================= */
function renderOrcamentistas() {
    let div = document.getElementById("listaOrcamentistas");
    div.innerHTML = "";

    orcamentistas.forEach((orc, i) => {
        let linha = document.createElement("div");
        linha.className = "flex justify-between bg-gray-800 p-3 rounded";

        linha.innerHTML = `
            <span>${orc}</span>
            <div class="flex gap-2">
                <button onclick="editarOrc(${i})" class="bg-yellow-600 text-black px-3 py-1 rounded">Editar</button>
                <button onclick="excluirOrc(${i})" class="bg-red-700 text-white px-3 py-1 rounded">Excluir</button>
            </div>
        `;
        div.appendChild(linha);
    });
}

function adicionarOrcamentista() {
    const nome = document.getElementById("novoOrcamentista").value.trim();
    if (!nome) return;
    orcamentistas.push(nome);
    salvar();
    renderOrcamentistas();
    document.getElementById("novoOrcamentista").value = "";
}

function editarOrc(i) {
    const novo = prompt("Editar nome:", orcamentistas[i]);
    if (!novo) return;
    orcamentistas[i] = novo.trim();
    salvar();
    renderOrcamentistas();
}

function excluirOrc(i) {
    if (!confirm("Excluir orçamentista?")) return;
    orcamentistas.splice(i, 1);
    salvar();
    renderOrcamentistas();
}

/* ========================= CRUD CLIENTES ========================= */
function renderClientes() {
    let div = document.getElementById("listaClientes");
    div.innerHTML = "";

    clientes.forEach((cli, i) => {
        let linha = document.createElement("div");
        linha.className = "flex justify-between bg-gray-800 p-3 rounded";

        linha.innerHTML = `
            <span>${cli}</span>
            <div class="flex gap-2">
                <button onclick="editarCliente(${i})" class="bg-yellow-600 text-black px-3 py-1 rounded">Editar</button>
                <button onclick="excluirCliente(${i})" class="bg-red-700 text-white px-3 py-1 rounded">Excluir</button>
            </div>
        `;
        div.appendChild(linha);
    });
}

function adicionarCliente() {
    const nome = document.getElementById("novoCliente").value.trim();
    if (!nome) return;
    clientes.push(nome);
    salvar();
    renderClientes();
    document.getElementById("novoCliente").value = "";
}

function editarCliente(i) {
    const novo = prompt("Editar nome:", clientes[i]);
    if (!novo) return;
    clientes[i] = novo.trim();
    salvar();
    renderClientes();
}

function excluirCliente(i) {
    if (!confirm("Excluir cliente?")) return;
    clientes.splice(i, 1);
    salvar();
    renderClientes();
}

/* ========================= CRUD ÍNDICES ========================= */
function renderIndices() {
    let div = document.getElementById("listaIndices");
    div.innerHTML = "";

    indices.forEach((idx, i) => {
        let linha = document.createElement("div");
        linha.className = "flex justify-between bg-gray-800 p-3 rounded";

        linha.innerHTML = `
            <span><b>${idx.id}</b> — ${idx.nome} (${idx.escopo})<br>
            <span class="text-gray-400">${idx.desc}</span></span>

            <div class="flex gap-2">
                <button onclick="editarIndice(${i})" class="bg-yellow-600 text-black px-3 py-1 rounded">Editar</button>
                <button onclick="excluirIndice(${i})" class="bg-red-700 text-white px-3 py-1 rounded">Excluir</button>
            </div>
        `;
        div.appendChild(linha);
    });
}

function adicionarIndice() {
    const id = document.getElementById("novoIndiceId").value.trim();
    const nome = document.getElementById("novoIndiceNome").value.trim();
    const escopo = document.getElementById("novoIndiceEscopo").value;
    const desc = document.getElementById("novoIndiceDesc").value.trim();

    if (!id || !nome) return;

    indices.push({ id, nome, escopo, desc });
    salvar();
    renderIndices();

    document.getElementById("novoIndiceId").value = "";
    document.getElementById("novoIndiceNome").value = "";
    document.getElementById("novoIndiceDesc").value = "";
}

function editarIndice(i) {
    const idx = indices[i];

    const novoId = prompt("ID:", idx.id);
    const novoNome = prompt("Nome:", idx.nome);
    const novoDesc = prompt("Descrição:", idx.desc);

    if (!novoId || !novoNome) return;

    idx.id = novoId.trim();
    idx.nome = novoNome.trim();
    idx.desc = novoDesc.trim();

    salvar();
    renderIndices();
}

function excluirIndice(i) {
    if (!confirm("Excluir índice?")) return;
    indices.splice(i, 1);
    salvar();
    renderIndices();
}

/* ========================= ÁREAS DO PROJETO ========================= */
function addAreaInput() {
    let container = document.getElementById("listaAreasProjeto");

    let div = document.createElement("div");
    div.className = "flex gap-2 items-center";

    div.innerHTML = `
        <input type="text" class="border p-2 rounded w-full areaProjeto">
        <button onclick="this.parentElement.remove()" class="bg-red-700 text-white px-3 py-1 rounded">X</button>
    `;

    container.appendChild(div);
}

/* ========================= SALVAR NOVO PROJETO ========================= */
function criarProjeto() {
    let nome = document.getElementById("nomeProjeto").value.trim();
    let obs = document.getElementById("obsProjeto").value.trim();
    let orc = document.getElementById("selecionarOrc").value;
    let cli = document.getElementById("selecionarCliente").value;

    if (!nome) {
        alert("O projeto precisa de um nome.");
        return;
    }

    let areas = [...document.querySelectorAll(".areaProjeto")]
        .map(a => a.value.trim())
        .filter(a => a);

    if (areas.length === 0) {
        alert("O projeto precisa de pelo menos uma área.");
        return;
    }

    let pesosIndices = [];
    let somaPesos = 0;

    indices.forEach(idx => {
        let check = document.getElementById(`idxCheck_${idx.id}`);
        let peso = document.getElementById(`idxPeso_${idx.id}`);

        if (check && check.checked) {
            let p = Number(peso.value);
            if (p > 0) {
                somaPesos += p;
                pesosIndices.push({ id: idx.id, peso: p });
            }
        }
    });

    if (somaPesos > 100) {
        alert("A soma dos pesos dos índices não pode ultrapassar 100.");
        return;
    }

    let incluirSWOT = document.getElementById("toggleSWOT").checked;

    let swot = incluirSWOT ? {
        forcas: document.getElementById("swotForcas").value,
        fraquezas: document.getElementById("swotFraquezas").value,
        oportunidades: document.getElementById("swotOportunidades").value,
        ameacas: document.getElementById("swotAmeacas").value
    } : null;

    projetos.push({
        id: Date.now(),
        nome,
        obs,
        orc,
        cli,
        areas,
        indices: pesosIndices,
        swot,
        status: "A iniciar",
        resultados: null
    });

    salvar();
    alert("Projeto criado!");
    abrirAba("abaProjetos");
}

/* ========================= LISTAR PROJETOS ========================= */
function listarProjetos() {
    let div = document.getElementById("listaProjetos");
    div.innerHTML = "";

    let filtroStatus = document.getElementById("filtroStatus").value;
    let filtroOrc = document.getElementById("filtroOrc").value;
    let filtroCli = document.getElementById("filtroCliente").value;

    let lista = projetos.filter(p =>
        (!filtroStatus || p.status === filtroStatus) &&
        (!filtroOrc || p.orc === filtroOrc) &&
        (!filtroCli || p.cli === filtroCli)
    );

    lista.forEach(p => {
        let card = document.createElement("div");
        card.className = "bg-gray-800 p-4 rounded shadow";

        card.innerHTML = `
            <h3 class="font-bold text-lg">${p.nome}</h3>
            <p class="text-gray-300">Orçamentista: ${p.orc}</p>
            <p class="text-gray-300">Cliente: ${p.cli}</p>
            <p class="text-gray-400 text-sm">Status: ${p.status}</p>

            <button onclick="abrirProjeto(${p.id})"
                class="bg-blue-700 text-white px-3 py-2 rounded mt-3 block">
                Abrir
            </button>
        `;

        div.appendChild(card);
    });
}
function abrirProjeto(id) {
    let p = projetos.find(x => x.id === id);
    if (!p) return;

    let div = document.getElementById("detalheProjeto");
    div.classList.remove("hidden");

    let fornecedores = calcularProjetoInterno(p);

    let fornecedoresHTML = fornecedores.map(f => `
        <tr>
            <td class="border px-2 py-1">${f.nome}</td>
            <td class="border px-2 py-1">${f.score.toFixed(2)}</td>
            <td class="border px-2 py-1">
                <canvas id="chart_${p.id}_${f.nome.replace(/\s+/g,'_')}" height="60"></canvas>
            </td>
        </tr>
    `).join("");

    div.innerHTML = `
        <div class="bg-gray-900 p-6 rounded text-white">
            <h2 class="text-2xl font-bold mb-2">${p.nome}</h2>
            <p><b>Orçamentista:</b> ${p.orc}</p>
            <p><b>Cliente:</b> ${p.cli}</p>
            <p><b>Status:</b> ${p.status}</p>
            <p class="mt-2 text-gray-300"><b>Observações:</b> ${p.obs || "(nenhuma)"}</p>

            <h3 class="text-xl font-bold mt-6 mb-2">Fornecedores considerados</h3>
            <table class="w-full text-sm">
                <tr class="bg-gray-700">
                    <th class="px-2 py-1">Fornecedor</th>
                    <th class="px-2 py-1">Score</th>
                    <th class="px-2 py-1">Gráfico</th>
                </tr>
                ${fornecedoresHTML}
            </table>

            ${p.swot ? `
            <h3 class="text-xl font-bold mt-6 mb-2">Matriz SWOT</h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-yellow-200 p-4 rounded text-black">
                    <h4 class="font-bold mb-2">Forças</h4>
                    <p>${p.swot.forcas.replace(/\n/g,"<br>")}</p>
                </div>

                <div class="bg-red-200 p-4 rounded text-black">
                    <h4 class="font-bold mb-2">Fraquezas</h4>
                    <p>${p.swot.fraquezas.replace(/\n/g,"<br>")}</p>
                </div>

                <div class="bg-green-200 p-4 rounded text-black">
                    <h4 class="font-bold mb-2">Oportunidades</h4>
                    <p>${p.swot.oportunidades.replace(/\n/g,"<br>")}</p>
                </div>

                <div class="bg-blue-200 p-4 rounded text-black">
                    <h4 class="font-bold mb-2">Ameaças</h4>
                    <p>${p.swot.ameacas.replace(/\n/g,"<br>")}</p>
                </div>
            </div>
            ` : ""}
            
            <div class="mt-6 flex gap-3">
                <button onclick="exportarPDF(${p.id})"
                    class="bg-green-600 text-white px-4 py-2 rounded">
                    Exportar PDF
                </button>

                <button onclick="fecharProjeto()"
                    class="bg-gray-600 text-white px-4 py-2 rounded">
                    Fechar
                </button>
            </div>
        </div>
    `;

    // Renderizar os gráficos
    fornecedores.forEach(f => {
        let ctx = document.getElementById(`chart_${p.id}_${f.nome.replace(/\s+/g,'_')}`).getContext("2d");

        new Chart(ctx, {
            type: "bar",
            data: {
                labels: ["Score"],
                datasets: [{
                    data: [f.score],
                    backgroundColor:
                        f.score >= 7 ? "#16a34a" :
                        f.score >= 4 ? "#facc15" :
                                        "#dc2626"
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, max: 10 } }
            }
        });
    });
}

function fecharProjeto() {
    document.getElementById("detalheProjeto").classList.add("hidden");
    document.getElementById("detalheProjeto").innerHTML = "";
}

function exportarPDF(id) {
    let p = projetos.find(x => x.id === id);
    if (!p) return;

    let elemento = document.getElementById("detalheProjeto");

    const opt = {
        margin: 10,
        filename: `Projeto_${p.nome.replace(/\s+/g,"_")}.pdf`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
    };

    html2pdf().set(opt).from(elemento).save();
}
/* ========================= INICIALIZAÇÃO ============================= */

function inicializarSistema() {
    carregarDados();
    popularSelects();
    renderFornecedores();
    renderOrc();
    renderClientes();
    renderIndices();
    renderProjetos();
    renderDashboard();
    addAreaRow(); // Ao abrir Projeto, sempre começa com 1 área obrigatória
}

window.onload = inicializarSistema;

/* ========================= EVENTOS / LISTENERS ======================== */

document.getElementById("swotToggle").addEventListener("change", function () {
    document.getElementById("swotContainer").classList.toggle("hidden", !this.checked);
});

/* ========================= UTILITÁRIOS =============================== */

function gerarID() {
    return Math.floor(Math.random() * 999999);
}

function formatArray(arr) {
    return arr.length ? arr.join(", ") : "(nenhuma)";
}

/* ========================= SALVAR DADOS ============================== */

function salvarDados() {
    localStorage.setItem("fornecedores", JSON.stringify(fornecedores));
    localStorage.setItem("indices", JSON.stringify(indicesCadastrados));
    localStorage.setItem("orcamentistas", JSON.stringify(orcamentistas));
    localStorage.setItem("clientes", JSON.stringify(clientes));
    localStorage.setItem("projetos", JSON.stringify(projetos));
}

function carregarDados() {
    fornecedores = JSON.parse(localStorage.getItem("fornecedores")) || fornecedores;
    indicesCadastrados = JSON.parse(localStorage.getItem("indices")) || indicesCadastrados;
    orcamentistas = JSON.parse(localStorage.getItem("orcamentistas")) || orcamentistas;
    clientes = JSON.parse(localStorage.getItem("clientes")) || clientes;
    projetos = JSON.parse(localStorage.getItem("projetos")) || projetos;
}

/* ========================= RESETAR FILTROS ============================ */

function resetFiltros() {
    document.getElementById("filtroArea").value = "";
    document.getElementById("filtroAreaNotas").value = "";
    renderFornecedores();
}

/* ========================= FIM DO ARQUIVO ============================= */

</script>
</body>
</html>
